name: CI/CD Pipeline for OCI Function

on:
  push:
    branches:
      - master  # Trigger the workflow on push to the master branch
  pull_request:
    branches:
      - master  # Trigger on pull requests to the master branch

jobs:
  # Job to build the Docker image
  build_image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:latest .
          docker tag iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:latest iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:${GITHUB_SHA}

  # Job to push the Docker image to OCI Container Registry
  push_image:
    runs-on: ubuntu-latest
    needs: build_image
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Log in to OCI Container Registry
        run: |
          echo "Logging into OCI Container Registry using Security Token..."
          oci --auth security_token --security-token "eyJraWQiOiJhc3dfaWFkXzE3MTU2NDgwNzIzNzciLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvY2lkMS51c2VyLm9jMS4uYWFhYWFhYWFzd3VhamRrM2ZndGVydzNnZG92dGxqd2gzYzdid2J3dGV2MzRudTZ2Y3d4YmxrN3RhbHlhIiwiaXNzIjoiYXV0aFNlcnZpY2Uub3JhY2xlLmNvbSIsInNhbWxfZnByaW50IjoiNjQ6Mzk6MjQ6ZmM6YmI6MGQ6NDE6ZTg6ZjA6MjM6NWQ6MzU6ODA6Mjg6MjI6ODMiLCJwdHlwZSI6InVzZXIiLCJzZXNzX2V4cCI6Ik1vbiwgMjUgTm92IDIwMjQgMTM6NDc6NDYgVVRDIiwiYXVkIjoib2NpIiwicHN0eXBlIjoibmF0ZiIsInR0eXBlIjoic2FtbGMiLCJleHAiOjE3MzI1MjA2NjYsImlhdCI6MTczMjUxNzA2NiwianRpIjoiNTJiODcwNzEtZDE0Ny00NmRjLWIwMWMtOTliMjFhYTM5OTI1IiwidGVuYW50Ijoib2NpZDEudGVuYW5jeS5vYzEuLmFhYWFhYWFhZ2tiemdnNmxwenJmNDd4enk0cmpveGc0ZGU2bmNmaXEycm5jbWppdWp2eTJoamd4dnppcSIsImlzX2ZlZCI6InRydWUiLCJncnBzIjoiIiwiandrIjoie1wia2lkXCI6XCJJZ25vcmVkXCIsXCJuXCI6XCJwVUk0ZjRPdEZUaS02NDl2Tjg2VEF1d1JVRTVDQlVLelRoTlItaTJTTFRvZ3NIYVozWWZMUUYtZXpLeFZpb0hEUFVOMUpmZHg2QzE5c1lfVWxWczV5cXhQV2JjR2U2b20xeGxLSmw0OGtrWDZNczBIN21jai1qa19CMWtjVFlmanRwSUhYR19mMnJ3Smc3Y0pOYUVfaGpQMkUySVFpTDNfbnRVOG9UaFVCeWp1eUd6RnVuVDZkcFR6NEt2YXpjZFJiR1Ewb18ybVVUb29uM3JKQjNsUEdNd2RRV0k5dFNmOFUwcUhXS2VqNk4zRF9lZ0Z4cDVYalhTcWFhODhYRU5ReGE0Q3daY2NOek9JTkl1NnNhRmJVM1FFdDJ2Wm9oUjlfU1hxR2RRa0NMaTZWdXBkQXJuUmNzMUFQM1VUZjhrNDhQMG1FM0xyYVprSEt5VzN2NTd1NFFcIixcImVcIjpcIkFRQUJcIixcImt0eVwiOlwiUlNBXCIsXCJ1c2VcIjpudWxsfSJ9.W05zP7vbt6RKNGWAILmGw8HcCg4dvja_rn4RWRai_EJFzTfFow-50hjyb5cni1NSSIVUwzx_Zwg6coTNnZU_w_D861IKS3E5PKiqtzH519d1Tvnytw0r3eCp_IblyCdfA-QEyzVMR9IL3HxEa04vJGRsrokTj88BlDActRI6QlsTBJ6ogRPM9nIk-I-WfWPEFwN21NePXF5GYIULB5lfeqH75p3kfC_JbE2l9Oh4ufizpxcerDwLuK7r4YHjohPtPG6ZwR1lu0BbWUsyNiGHJ6fACCvkZHz39UpB27ll2nF66osPKnWp5_FieBP8SZsumn6kqKFtNrVJut5LIKZKuA"
      - name: Push Docker image to OCI Container Registry
        run: |
          echo "Pushing Docker image to OCI Container Registry..."
          docker push iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:latest
          docker push iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:${GITHUB_SHA}

  # Job to deploy the image to an existing OCI Function
  deploy_function:
    runs-on: ubuntu-latest
    needs: push_image
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
      - name: Update Docker image for OCI Function
        run: |
          echo "Updating Docker image for existing OCI Function..."
          oci fn function update --compartment-id ocid1.compartment.oc1..aaaaaaaai7lpqrjb65oxp7yot4cdlgahobld5xpizdyjyaoef2tjunipxhpa --function-id ocid1.fnfunc.oc1.iad.aaaaaaaajmotp4ycz5pms3y4q3zqdxra6fyg53fxu2ap36yvqoglkbjwxmka --image iad.ocir.io/idlcbf4ihtx7/test-a/test-one/image-file:latest
      - name: Create or update HTTP trigger for OCI Function
        run: |
          echo "Creating or updating HTTP trigger for function..."
          oci fn trigger create \
            --compartment-id ocid1.compartment.oc1..aaaaaaaai7lpqrjb65oxp7yot4cdlgahobld5xpizdyjyaoef2tjunipxhpa \
            --function-id ocid1.fnfunc.oc1.iad.aaaaaaaajmotp4ycz5pms3y4q3zqdxra6fyg53fxu2ap36yvqoglkbjwxmka \
            --name my-http-trigger \
            --type http
      - name: Invoke the OCI Function
        run: |
          echo "Invoking OCI function..."
          oci fn function invoke --function-id ocid1.fnfunc.oc1.iad.aaaaaaaajmotp4ycz5pms3y4q3zqdxra6fyg53fxu2ap36yvqoglkbjwxmka --body '{}'

