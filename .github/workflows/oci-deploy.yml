name: OCI Docker Build and Push
on:
  push:
    branches:
      master
  pull_request:
    branches:
      master
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up OCI CLI
        uses: oracle/oci-cli-action@v2
        with:
          oci-cli-version: 'latest'

      - name: Set OCI Credentials
        run: |
          echo "OCI_USERNAME=${{ secrets.OCI_USERNAME }}" >> $GITHUB_ENV
          echo "OCI_PASSWORD=${{ secrets.OCI_PASSWORD }}" >> $GITHUB_ENV
          echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "OCI_NAMESPACE=${{ secrets.OCI_NAMESPACE }}" >> $GITHUB_ENV
          echo "OCI_REPO=${{ secrets.OCI_REPO }}" >> $GITHUB_ENV

      - name: Docker login to OCIR
        run: |
          echo "$OCI_PASSWORD" | docker login -u "$OCI_USERNAME" --password-stdin iad.ocir.io

      - name: Build Docker image
        run: |
          docker build -t $OCI_REGION.ocir.io/$OCI_NAMESPACE/$OCI_REPO/myimage:latest .

      - name: Push Docker image to OCIR
        run: |
          docker push $OCI_REGION.ocir.io/$OCI_NAMESPACE/$OCI_REPO/myimage:latest